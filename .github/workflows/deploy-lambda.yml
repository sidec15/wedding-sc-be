name: 🚀 Package & Deploy Lambda

defaults:
  run:
    shell: bash

on:
  workflow_dispatch:
    inputs:
      folder:
        description: "Lambda folder/name (under lambdas/)"
        type: choice
        required: true
        options:
          - comment-create
          - comment-read
          - contact-us
          - email-dispatcher
          - notification-manager
          - subscription-create
          - subscription-delete
          - subscription-read
        default: email-dispatcher
      function_name:
        description: "AWS Lambda function name"
        type: choice
        required: true
        options:
          - wedding-comment-create
          - wedding-comment-read
          - wedding-contact-us
          - email-dispatcher
          - wedding-notification-manager
          - wedding-subscription-create
          - wedding-subscription-delete
          - wedding-subscription-read
        default: email-dispatcher
      region:
        description: "AWS region"
        type: string
        required: true
        default: eu-west-1

env:
  NODE_VERSION: "22"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: 🧳 Checkout
        uses: actions/checkout@v4

      - name: 🧰 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: 🔑 Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ github.event.inputs.region }}

      - name: 🛠️ Install + Build common
        run: |
          cd common
          npm ci
          npm run build

      - name: 🧱 Install + Build (prod) lambda
        run: |
          cd "lambdas/${{ github.event.inputs.folder }}"
          npm ci
          npm run build:prod

      - name: 📦 Zip lambda
        run: |
          cd "lambdas/${{ github.event.inputs.folder }}"
          npm run zip
          test -f lambda.zip || (echo "lambda.zip not found" && exit 1)
          # quick peek
          unzip -l lambda.zip | sed -n '1,25p'

      - name: ☁️ Deploy to AWS Lambda
        run: |
          aws lambda update-function-code \
            --function-name "${{ github.event.inputs.function_name }}" \
            --zip-file "fileb://lambdas/${{ github.event.inputs.folder }}/lambda.zip" \
            --publish \
            --region "${{ github.event.inputs.region }}"

      - name: 🗂️ Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.function_name }}.zip
          path: lambdas/${{ github.event.inputs.folder }}/lambda.zip
          if-no-files-found: error
          retention-days: 7
